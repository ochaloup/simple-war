= Simple war

A simple war application.

== How to on OpenShift with EAP development

* Deploy an Operator with EAP changeset
+
NOTE: EAP Operator changes to https://github.com/wildfly/wildfly-operator[WildFlyOperator] is at https://github.com/jbossas/eap-operator-packaging/blob/cde6f7dbfeac73ce6fd7a13272d86de227157766/eap-operator/cekit/image.yaml#L20
+
[source,sh]
----
git clone https://github.com/ochaloup/wildfly-operator.git -b eap-operator-on-master
----
+
* Create EAP ImageStreams defined in https://github.com/jboss-container-images/jboss-eap-openshift-templates
+
[source,sh]
----
oc create -f \
  https://raw.githubusercontent.com/jboss-container-images/jboss-eap-openshift-templates/eap74/eap74-openjdk11-image-stream.json
----
+
* Manual image download could be needed if the ImageStream download fails
+
[source,sh]
----
# if following fails
oc describe is jboss-eap74-openjdk11-openshift

# manual pull and push to OC
docker login registry.redhat.io
docker pull registry-proxy.engineering.redhat.com/rh-osbs/jboss-eap-7-tech-preview-eap74-openjdk11-openshift-rhel8:7.4.0.Beta-4
docker tag registry-proxy.engineering.redhat.com/rh-osbs/jboss-eap-7-tech-preview-eap74-openjdk11-openshift-rhel8:7.4.0.Beta-4 default-route-openshift-image-registry.apps-crc.testing/$(oc project -q)/jboss-eap74-openjdk11-openshift:7.4.0
docker push default-route-openshift-image-registry.apps-crc.testing/$(oc project -q)/jboss-eap74-openjdk11-openshift:7.4.0 --tls-verify=false

----
+
* Build the `simple-war.war` with `mvn clean package`
* Prepare directory to create a build from `mkdir target/openshift`
* Copy resources to the directory `cp target/simple-war.war target/openshift`
* Create a build and start a build of the `simple-war` application
+
[source,sh]
----
oc new-build --strategy source --binary --image-stream jboss-eap74-openjdk11-openshift:7.4.0 --name simple-war
oc start-build simple-war --from-dir target/openshift
----
+
* Prepare application template for Operator to deploy it
+
[source,yaml]
----
cat > /tmp/operator-template-cr.yaml <<EOF
# OpenShift template for creating WildFlyServer object parametrized with application image
apiVersion: v1
kind: Template
metadata:
  name: wfly-operator-template
  annotations:
    description: "Starting WildFlyOperator application"
    tags: "wildfly,operator,application"
parameters:
  - description: Application name
    name: APPLICATION_NAME
    value: simple-war
  - description: S2I built application image
    name: APPLICATION_IMAGE
    value: image-registry.openshift-image-registry.svc:5000/projectname/simple-war:latest
labels:
  template: "wildfly-operator-application-template"
objects:
  - apiVersion: wildfly.org/v1alpha1
    kind: WildFlyServer
    metadata:
      name: \${APPLICATION_NAME}
    spec:
      applicationImage: \${APPLICATION_IMAGE}
      replicas: 1
      # false as running with standalone WildFly
      bootableJar: false
EOF
----
+
* Better to add a viewer role to not get cluster failures
+
[source,sh]
----
oc policy add-role-to-user view system:serviceaccount:$(oc project -q):default -n $(oc project -q)
----
+
* Create the application based on the template
+
[source,sh]
----
oc process -n $(oc project -q) -f /tmp/operator-template-cr.yaml \
      -p APPLICATION_IMAGE=image-registry.openshift-image-registry.svc:5000/$(oc project -q)/simple-war \
      -p APPLICATION_NAME=simple-war \
  | oc create -f -
----
+
* Patch the replica size
+
[source,sh]
----
oc patch wildflyserver simple-war -p '[{"op":"replace", "path":"/spec/replicas", "value":3}]' --type json
----

=== Tools

[source,sh]
----
# print log from Operator
oc logs -f $(oc get po | grep wildfly-operator | awk '{print $1}')
# print log from Operator and save it under a log file
rm -f /tmp/operator.log; oc logs -f $(oc get po | grep wildfly-operator | awk '{print $1}') | tee /tmp/operator.log
# delete the wildfly operator pod
oc delete po $(oc get po | grep wildfly-operator | awk '{print $1}')
----
